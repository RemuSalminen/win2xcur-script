#!/usr/bin/env bash

SCRIPT_DIR=$( cd -- "$( dirname --  "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# Initial directory
original_dir="$SCRIPT_DIR/output/test-cursor"
theme_file="$original_dir/index.theme"

# Function to update index.theme with new values
update_theme_file() {
    local name="$1"
    local comment="$2"

    # Ensure the file exists with a [Icon Theme] section
    if ! grep -q "^\[Icon Theme\]" "$theme_file"; then
        echo "[Icon Theme]" > "$theme_file"
    fi

    # Remove old Name and Comment lines (only under [Icon Theme])
    sed -i '/^\[Icon Theme\]/,/^\[.*\]/ {
        /^Name=/d
        /^Comment=/d
    }' "$theme_file"

    # Append new Name and Comment under [Icon Theme]
    sed -i "/^\[Icon Theme\]/a Name=$name\nComment=$comment" "$theme_file"
}

# Function to rename the directory after updating index.theme
rename_directory() {
    local name="$1"
    # Replace spaces with dashes
    safe_name="${name// /-}"
    new_dir="$SCRIPT_DIR/output/$safe_name"

    if [ "$original_dir" != "$new_dir" ]; then
        mv "$original_dir" "$new_dir"
        echo "Directory renamed to $new_dir"
    fi
}

# Function using yad
use_yad() {
    user_input=$(yad --form \
        --title="Update Theme Info" \
        --field="Name" \
        --field="Comment" \
        --width=400 --height=150)

    if [[ $? -ne 0 ]]; then
        yad --info --text="You cancelled the input." --width=300
        exit 1
    fi

    name=$(echo "$user_input" | cut -d '|' -f1)
    comment=$(echo "$user_input" | cut -d '|' -f2)

    update_theme_file "$name" "$comment"
    rename_directory "$name"
    yad --info --text="index.theme updated and directory renamed!" --width=300
}

# Function using zenity
use_zenity() {
    name=$(zenity --entry \
        --title="Update Theme Info" \
        --text="Enter Name:")

    if [[ $? -ne 0 ]]; then
        zenity --info --text="You cancelled the input."
        exit 1
    fi

    comment=$(zenity --entry \
        --title="Update Theme Info" \
        --text="Enter Comment:")

    if [[ $? -ne 0 ]]; then
        zenity --info --text="You cancelled the input."
        exit 1
    fi

    update_theme_file "$name" "$comment"
    rename_directory "$name"
    zenity --info --text="index.theme updated and directory renamed!"
}

# Main logic
if command -v yad >/dev/null 2>&1; then
    use_yad
elif command -v zenity >/dev/null 2>&1; then
    use_zenity
else
    echo "Error: Neither 'yad' nor 'zenity' is installed."
    exit 1
fi
