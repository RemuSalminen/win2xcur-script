#!/usr/bin/env bash

SCRIPT_DIR=$( cd -- "$( dirname --  "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# Set paths
project_dir="$SCRIPT_DIR"
log_dir="$project_dir/.logs"
timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
log_file="$log_dir/run_$timestamp.log"

# Create log directory if it doesn't exist
mkdir -p "$log_dir"

# Redirect all output (stdout and stderr) to the log file
exec > >(tee -a "$log_file") 2>&1

echo "ğŸ•’ Script started at $(date)"
echo "ğŸ“ Project directory: $project_dir"
echo "ğŸ“ Logging to: $log_file"

# Change to the project directory
if ! cd "$project_dir"; then
  echo "âŒ Failed to enter $project_dir"
  echo "ğŸ›‘ Critical failure: cannot continue."
  exit 1
fi

# Track status of each step
sorting_success=true
convert_success=true
detail_success=true

# Run the sorting script
echo "ğŸ”„ Running sorting..."
if ./sorting; then
  echo "âœ… Sorting complete."
else
  echo "âŒ sorting failed."
  sorting_success=false
fi

# Run the convert script
echo "ğŸ”§ Running convert..."
if ./convert; then
  echo "âœ… Conversion complete."
else
  echo "âŒ convert failed."
  convert_success=false
fi

# Run the detail script
echo "ğŸ“‹ Running detail..."
if ./detail; then
  echo "âœ… Detail script completed."
else
  echo "âŒ detail script failed."
  detail_success=false
fi

echo "ğŸ•’ Script ended at $(date)"

# Final summary
echo "ğŸ“¦ Summary:"
$sorting_success   && echo "  âœ” Sorting succeeded."   || echo "  âŒ Sorting failed."
$convert_success   && echo "  âœ” Convert succeeded."   || echo "  âŒ Convert failed."
$detail_success    && echo "  âœ” Detail succeeded."    || echo "  âŒ Detail failed."

if $sorting_success && $convert_success && $detail_success; then
  echo "ğŸ‰ All steps completed successfully!"
else
  echo "âš ï¸ Some steps failed. Check the log at $log_file for details."
fi
